<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Certificate Generator</title>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body { font-family: Times, serif; padding: 40px; background: #f6f7f9; }
    .box { background: #fff; padding: 30px; max-width: 600px; margin: auto; border-radius: 8px; }
    label { font-weight: bold; margin-top: 15px; display: block; }
    button { margin-top: 20px; padding: 10px 20px; }
  </style>
</head>
<body>

<div class="box">
  <h2>Certificate Generator</h2>

  <label>Certificate PDF Template</label>
  <input type="file" id="pdf" accept="application/pdf">

  <label>CSV File</label>
  <input type="file" id="csv" accept=".csv">

  <button onclick="run()">Generate ZIP</button>
</div>

<script>
let templateBytes = null

document.getElementById("pdf").addEventListener("change", async e => {
  templateBytes = await e.target.files[0].arrayBuffer()
})

async function run() {
  if (!templateBytes) return alert("Upload PDF template")
  const csvFile = document.getElementById("csv").files[0]
  if (!csvFile) return alert("Upload CSV")

  Papa.parse(csvFile, {
    header: true,
    skipEmptyLines: true,
    complete: async res => generateZIP(res.data)
  })
}

async function generateZIP(rows) {
  const zip = new JSZip()

  for (const row of rows) {
    if (!row.email) continue

    const pdfDoc = await PDFLib.PDFDocument.load(templateBytes)
    const page = pdfDoc.getPages()[0]

    const bold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
    const regular = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica)

    // PDF metadata (trust)
    pdfDoc.setTitle("Certificate")
    pdfDoc.setAuthor("Certificate Generator")
    pdfDoc.setProducer("Internal Certificate Tool")
  
  
    const titleTickX = {
      "Mr.": 290,
      "Ms.": 314,
      "Mrs.": 350,
      "Dr.": 378 
    }
    
    const tickX = titleTickX[row.title]
    const tickY = 318
    
    page.drawLine({
      start: { x: tickX, y: tickY },
      end:   { x: tickX + 4, y: tickY - 6 },
      thickness: 1.5
    })
    
    page.drawLine({
      start: { x: tickX + 4, y: tickY - 6 },
      end:   { x: tickX + 12, y: tickY + 6 },
      thickness: 1.5
    })

    // ---- ADJUST COORDINATES AS NEEDED ----
    page.drawText(`${row.title} ${row.name}`, {
      x: 398,
      y: 301,
      size: 18,
      font: bold
    })

    page.drawText(row.register_number, {
      x: 284,
      y: 274,
      size: 14,
      font: regular
    })

    page.drawText(row.address, {
      x: 238,
      y: 249,
      size: 14,
      font: regular,
      maxWidth: 330,
      lineHeight: 16
    })

    const pdfBytes = await pdfDoc.save()
    const filename = `${row.email}.pdf`.replace(/[<>:"/\\|?*]+/g, "")
    zip.file(filename, pdfBytes)
  }

  const blob = await zip.generateAsync({
    type: "blob",
    compression: "DEFLATE",
    compressionOptions: { level: 6 }
  })

  saveAs(blob, "certificates.zip")
}
</script>

</body>
</html>

